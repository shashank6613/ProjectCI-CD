pipeline {
    agent any

    environment {
        AWS_CREDENTIALS_ID = 'aws-creds'
        CLUSTER_NAME = 'my-cluster'
        REGION = 'us-east-1'
        ANSIBLE_INVENTORY = 'inventory.ini'
    }

    stages {
        stage('Setup Environment') {
            steps {
                script {
                     // Install Ansible (if not already installed)
                     sh '''
                         if ! command -v ansible &> /dev/null
                         then
                             pip install ansible
                         fi
                     '''
                    // Define the Ansible playbooks
                    def ansiblePlaybooks = [
                        'install_awscli.yaml',
                        'install_eksctl.yaml',
                        'install_kubectl.yaml'
                    ]
                    // Execute the Ansible playbooks
                    for (playbook in ansiblePlaybooks) {
                        sh "ansible-playbook -i ${ANSIBLE_INVENTORY} ${playbook}"
                    }
                }
            }
        }
        stage('Create EKS Cluster') {
            steps {
                withAWS(credentials: "${AWS_CREDENTIALS_ID}", region: "${REGION}") {
                    script {
                        sh '''
                            # Create EKS Cluster
                            eksctl create cluster \
                                --name ${CLUSTER_NAME} \
                                --version 1.30 \
                                --region ${REGION} \
                                --nodegroup-name standard-workers \
                                --node-type t3.medium \
                                --nodes 1 \
                                --nodes-min 1 \
                                --nodes-max 1 \
                                --managed
                        '''
                    }
                }
            }
        }
    }

    post {
        success {
            // Trigger the deployment pipeline
            build job: 'jenkinsfile-Deploy-To-Cluster', wait: true, parameters: [
                string(name: 'CLUSTER_NAME', value: CLUSTER_NAME),
                string(name: 'REGION', value: REGION)
            ]
        }
        failure {
            echo 'EKS cluster creation failed.'
        }
    }
}
